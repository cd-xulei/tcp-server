"use strict";const net=require("net"),logger=require("./helpers/logger.js").getLogger("index"),PORT=process.env.PORT||3389,server=net.createServer(),_=require("lodash"),heart=require("./protocol/heart.js"),sockets={};server.on("connection",function(e){e.on("data",async r=>{if(logger.debug("接收的数据 hex:",r.toString("hex")),!Buffer.isBuffer(r))return;if(r.length<32)return;if("aa55"!==r.toString("hex",0,2))return;const s=await heart(r);sockets[s.machineId]=Object.assign(_.omit(s,["resBuffer"]),{socket:e}),sockets[s.machineId].socket.write(s.resBuffer)}),e.on("close",function(){})}),server.on("error",function(e){logger.error(e.message)}),server.on("close",function(){logger.debug("server close")}),server.listen(PORT,()=>{const e=server.address();logger.debug(`tcp server listening on ${e.port}`),setInterval(()=>{server.getConnections((e,r)=>{if(e)return logger.error(e.message)})},2e3)});