"use strict";const logger=require("../helpers/logger.js").getLogger("heart"),hashFunc=require("../helpers/hashFunc.js"),redisCli=require("../helpers/redis.js"),_=require("lodash");let MachineType={};function buildVersionStr(e){let i="V";for(let t=0;t<4;t++)i+=parseInt(e.substr(2*t,2)),3!==t&&(i+=".");return i}MachineType[MachineType.MachineTypeNormal=1]="MachineTypeNormal",MachineType[MachineType.MachineTypeDirect=2]="MachineTypeDirect",MachineType[MachineType.MachineTypeTurnover=3]="MachineTypeTurnover",module.exports=async function(e){e.toString("hex",0,2);let i=e.toString("ascii",2,18),t=e.readUInt32LE(18),r=e.toString("hex",22,26),a=e.readUInt16BE(26),n=e.readUInt8(28),s=e.readUInt8(29),l=e.readUInt8(30),c=MachineType.MachineTypeNormal;logger.debug(`设备id: ${i}`);let g=e.readUInt8(31);logger.debug("当前数据包类型: 心跳");const o=await redisCli.get(`${i}_state`);if(o){let e;try{e=JSON.parse(o)}catch(i){e=null}_.isEmpty(e)||2!==e.mode&&3!==e.mode||(c=MachineType.MachineTypeDirect),0===l&&(e.wifi=n,e.mobile=0),1===l&&(e.wifi=0,e.mobile=s),e.flag=l,e.speed=a,e.version=buildVersionStr(r),await redisCli.set(`${i}_state`,JSON.stringify(e))}const d=`模式: ${c}, 版本: ${buildVersionStr(r)}, 转速: ${a}`;if(0===l&&logger.debug(`信号方式: wifi; 信号强度: ${n}, ${d}`),1===l&&logger.debug(`信号方式: gprs; 信号强度: ${s}, ${d}`),1===g)return null;const h=~~(Date.now()/1e3);let u=Buffer.alloc(32);u.writeUInt16LE(21930,0),u.write(i,2,16,"ascii"),u.writeUInt32LE(t,18),u.writeUInt32LE(h,22);let p=await redisCli.get(`${i}_activited`),y=p?Number(p):0,T=await redisCli.get(`${i}_lastTick`),w=T?Number(T):0;if(await redisCli.set(`${i}_lastTick`,h.toString()),a>1){if(await redisCli.exists(`${i}_lastUse`)){let e=h-w;e<=300&&await redisCli.incrby(`${i}_useTime`,e)}await redisCli.set(`${i}_lastUse`,1),await redisCli.expire(`${i}_lastUse`,300)}else await redisCli.del(`${i}_lastUse`);let M=c===MachineType.MachineTypeDirect?h+300:y;return logger.debug("当前时间:",h),logger.debug("关闭时间:",M),u.writeUInt32LE(h+300,26),u.writeInt8(0,30),u.writeInt8(0,31),u=hashFunc(u),logger.debug("回复心跳 hex串:",u.toString("hex")),logger.debug("\r\n"),{resBuffer:u,machineId:i,frameType:g}};